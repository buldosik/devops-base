name: _Ansible Run (reusable)

on:
  workflow_call:
    inputs:
      ansible_dir:
        type: string
        required: false
        default: ansible
      inventory:
        type: string
        required: false
        default: inventory.py
      playbook:
        type: string
        required: true
      limit:
        type: string
        required: false
        default: ""
      tags:
        type: string
        required: false
        default: ""
      extra_vars:
        type: string
        required: false
        default: ""
    secrets:
      TF_TOKEN_app_terraform_io:
        required: true

jobs:
  run:
    runs-on: [self-hosted, wsl, host]
    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.ansible_dir }}

    steps:
      - uses: actions/checkout@v4

      - name: Terraform init (for inventory)
        working-directory: devops-vm-terraform-libvirt
        env:
          TF_TOKEN_app_terraform_io: ${{ secrets.TF_TOKEN_app_terraform_io }}
        run: terraform init -input=false

      - name: Ensure tools installed
        run: |
          if ! command -v ansible-playbook >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y ansible python3
          fi

      - name: Prepare inventory
        run: |
          chmod +x "${{ inputs.inventory }}"
          ansible-inventory -i "${{ inputs.inventory }}" --list

      - name: Update SSH known_hosts
        run: |
          chmod +x scripts/update_known_hosts.py
          scripts/update_known_hosts.py

      - name: Run playbook
        run: |
          args=()
          if [ -n "${{ inputs.limit }}" ]; then args+=(--limit "${{ inputs.limit }}"); fi
          if [ -n "${{ inputs.tags }}" ]; then args+=(--tags "${{ inputs.tags }}"); fi
          if [ -n "${{ inputs.extra_vars }}" ]; then args+=(--extra-vars "${{ inputs.extra_vars }}"); fi

          ansible-playbook -i "${{ inputs.inventory }}" "${{ inputs.playbook }}" "${args[@]}"

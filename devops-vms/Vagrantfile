Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/focal64"

  # Статический IP (если вдруг захочешь ходить по 192.168.56.10)
  config.vm.network "private_network", ip: "192.168.56.10"

  # Проброс backend наружу
  config.vm.network "forwarded_port", guest: 8000, host: 8000

  config.vm.provision "shell", inline: <<-SHELL
    apt-get update
    apt-get install -y docker.io

    docker network create devops-net || true

    docker rm -f backend devops-postgres || true

    docker run -d \
      --name devops-postgres \
      --network devops-net \
      -e POSTGRES_DB=appdb \
      -e POSTGRES_USER=appuser \
      -e POSTGRES_PASSWORD=apppass \
      -v /srv/postgres-data:/var/lib/postgresql/data \
      postgres:16

    docker pull buldosik/devops-backend:1.1

    docker run -d \
      --name backend \
      --network devops-net \
      -p 8000:8000 \
      -e POSTGRES_DB=appdb \
      -e POSTGRES_USER=appuser \
      -e POSTGRES_PASSWORD=apppass \
      -e POSTGRES_HOST=devops-postgres \
      -e POSTGRES_PORT=5432 \
      buldosik/devops-backend:1.1

  SHELL
end

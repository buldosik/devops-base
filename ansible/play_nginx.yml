- name: Nginx on back (HTTPS reverse proxy)
  hosts: back
  become: true

  vars:
    cert_dir: /srv/nginx/certs
    conf_dir: /srv/nginx/conf.d
    backend_instances: [1, 2]

  pre_tasks:
    - name: Ensure nginx dirs exist
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ conf_dir }}"
        - "{{ cert_dir }}"

    - name: Remove existing cert/key (dev)
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ cert_dir }}/cert.pem"
        - "{{ cert_dir }}/key.pem"
        - "{{ cert_dir }}/openssl.cnf"

    - name: Generate self-signed cert
      shell: |
        set -e
        cat > {{ cert_dir }}/openssl.cnf <<EOF
        [req]
        prompt = no
        default_md = sha256
        x509_extensions = v3_req
        distinguished_name = dn

        [dn]
        CN = devops-back

        [v3_req]
        subjectAltName = IP:{{ ansible_host }}
        EOF

        openssl req -x509 -nodes -days 365 \
          -newkey rsa:2048 \
          -keyout {{ cert_dir }}/key.pem \
          -out {{ cert_dir }}/cert.pem \
          -config {{ cert_dir }}/openssl.cnf
      args:
        executable: /bin/bash

    - name: Upload nginx config
      template:
        src: nginx/app.conf.j2
        dest: "{{ conf_dir }}/app.conf"
        mode: "0644"

  roles:
    - role: my.systemd-service
      vars:
        systemd_services:
          devops-nginx:
            name: devops-nginx
            description: "Nginx reverse proxy (TLS) container"
            after: "network-online.target docker.service"
            wants: "network-online.target docker.service"
            type: simple
            exec_start: >
              /usr/bin/docker run --rm --name devops-nginx
              --network devops-net
              -p 80:80
              -p 443:443
              -v /srv/nginx/conf.d:/etc/nginx/conf.d:ro
              -v /srv/nginx/certs:/etc/nginx/certs:ro
              nginx:alpine
            restart: always
            enabled: true
